<ui-page-header title="Historial de cambios" [subtitle]="subtitle" [actions]="true">
  <div actions class="flex flex-wrap gap-2 ml-auto">
    <button mat-stroked-button (click)="cargarHistorial()">
      <mat-icon class="mr-1">refresh</mat-icon> Recargar
    </button>

    <mat-button-toggle-group class="density-toggle" [value]="density" (change)="setDensity($event.value)">
      <mat-button-toggle value="comfortable">Cómoda</mat-button-toggle>
      <mat-button-toggle value="compact">Compacta</mat-button-toggle>
      <mat-button-toggle value="ultra">Ultra</mat-button-toggle>
    </mat-button-toggle-group>
  </div>
</ui-page-header>

<!-- ===== Barra de filtros ===== -->
<div class="filters-bar card compact">
  <div class="filters-top">
    <mat-form-field appearance="fill" class="dense-field w-280">
      <input matInput [(ngModel)]="textoBusqueda" placeholder="Buscar (responsable, descripción, nombre)…" (input)="aplicarFiltros()" />
      <button *ngIf="textoBusqueda" matSuffix mat-icon-button aria-label="Limpiar" (click)="textoBusqueda=''; aplicarFiltros()">
        <mat-icon>close</mat-icon>
      </button>
    </mat-form-field>

    <div class="filters-actions">
      <button mat-stroked-button (click)="filtrosAbiertos = !filtrosAbiertos">
        <mat-icon>{{ filtrosAbiertos ? 'filter_alt_off' : 'filter_alt' }}</mat-icon>
        {{ filtrosAbiertos ? 'Ocultar filtros' : 'Más filtros' }}
        <span *ngIf="filtrosActivos">&nbsp;({{ filtrosActivos }})</span>
      </button>
      <button mat-button (click)="limpiarFiltros()" [disabled]="!filtrosActivos">
        <mat-icon>backspace</mat-icon> Limpiar
      </button>
    </div>
  </div>

  <div *ngIf="filtrosAbiertos" class="filters-advanced">
    <div class="grid auto-fit">
      <mat-form-field appearance="fill" floatLabel="always" class="dense-field">
        <mat-label>Tipo</mat-label>
        <mat-select [(ngModel)]="tipoSeleccionado" (selectionChange)="aplicarFiltros()">
          <mat-option [value]="null">— Todos —</mat-option>
          <mat-option *ngFor="let t of tipos" [value]="t">{{ t }}</mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="fill" floatLabel="always" class="dense-field">
        <mat-label>Responsable</mat-label>
        <mat-select [(ngModel)]="responsableSeleccionado" (selectionChange)="aplicarFiltros()">
          <mat-option [value]="null">— Todos —</mat-option>
          <mat-option *ngFor="let r of responsables" [value]="r">{{ r }}</mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="fill" floatLabel="always" class="dense-field">
        <mat-label>ID Colaborador</mat-label>
        <input matInput type="number" [(ngModel)]="colaboradorId" (input)="aplicarFiltros()">
      </mat-form-field>

      <mat-form-field appearance="fill" floatLabel="always" class="dense-field">
        <mat-label>Desde</mat-label>
        <input matInput [matDatepicker]="dp1" [(ngModel)]="fechaDesde" (dateChange)="aplicarFiltros()">
        <mat-datepicker-toggle matSuffix [for]="dp1"></mat-datepicker-toggle>
        <mat-datepicker #dp1></mat-datepicker>
      </mat-form-field>

      <mat-form-field appearance="fill" floatLabel="always" class="dense-field">
        <mat-label>Hasta</mat-label>
        <input matInput [matDatepicker]="dp2" [(ngModel)]="fechaHasta" (dateChange)="aplicarFiltros()">
        <mat-datepicker-toggle matSuffix [for]="dp2"></mat-datepicker-toggle>
        <mat-datepicker #dp2></mat-datepicker>
      </mat-form-field>
    </div>

    <div class="quick-row">
      <span class="muted">Rápidos:</span>
      <button mat-stroked-button (click)="preset7d()">Últimos 7 días</button>
      <button mat-stroked-button (click)="preset30d()">Últimos 30 días</button>
      <button mat-button (click)="presetTodo()">Todo</button>
    </div>
  </div>
</div>

<mat-progress-bar *ngIf="loading" mode="indeterminate"></mat-progress-bar>

<!-- ===== Tabla ===== -->
<div class="table-shell card">
  <div class="table-scroll">
    <!-- Usamos el API de componentes: mat-table / mat-header-row / mat-row -->
    <mat-table [dataSource]="dataSource" matSort class="table">
      <!-- Fecha -->
      <ng-container matColumnDef="fechaHora">
        <mat-header-cell *matHeaderCellDef mat-sort-header>Fecha</mat-header-cell>
        <mat-cell *matCellDef="let row">
          {{ row.fechaHora | date:'yyyy-MM-dd HH:mm' }}
        </mat-cell>
      </ng-container>

      <!-- Tipo -->
      <ng-container matColumnDef="tipoCambio">
        <mat-header-cell *matHeaderCellDef mat-sort-header>Tipo</mat-header-cell>
        <mat-cell *matCellDef="let row">
          <span class="type-chip" [class.t-asg]="row.tipoCambio==='ASIGNACION'"
                [class.t-y1]="row.tipoCambio==='DESCANSO_Y1'"
                [class.t-y2]="row.tipoCambio==='DESCANSO_Y2'"
                [class.t-sug]="row.tipoCambio==='SUGERENCIA'"
                [class.t-man]="row.tipoCambio==='MANUAL'">
            {{ row.tipoCambio }}
          </span>
        </mat-cell>
      </ng-container>

      <!-- Descripción -->
      <ng-container matColumnDef="descripcion">
        <mat-header-cell *matHeaderCellDef>Descripción</mat-header-cell>
        <mat-cell *matCellDef="let row">
          <span [matTooltip]="row.descripcion" matTooltipShowDelay="300">{{ row.descripcion }}</span>
        </mat-cell>
      </ng-container>

      <!-- Responsable -->
      <ng-container matColumnDef="realizadoPor">
        <mat-header-cell *matHeaderCellDef mat-sort-header>Responsable</mat-header-cell>
        <mat-cell *matCellDef="let row">{{ row.realizadoPor }}</mat-cell>
      </ng-container>

      <!-- ID Colaborador -->
      <ng-container matColumnDef="colaboradorId">
        <mat-header-cell *matHeaderCellDef mat-sort-header>ID Colaborador</mat-header-cell>
        <mat-cell *matCellDef="let row">{{ row.colaboradorId || '—' }}</mat-cell>
      </ng-container>

      <!-- Nombre -->
      <ng-container matColumnDef="colaboradorNombre">
        <mat-header-cell *matHeaderCellDef mat-sort-header>Nombre</mat-header-cell>
        <mat-cell *matCellDef="let row">{{ row.colaboradorNombre || '—' }}</mat-cell>
      </ng-container>

      <mat-header-row *matHeaderRowDef="displayedColumns" class="table-head"></mat-header-row>
      <mat-row *matRowDef="let row; columns: displayedColumns;"></mat-row>
    </mat-table>
  </div>

  <mat-paginator [pageSize]="25" [pageSizeOptions]="[10,25,50,100]" showFirstLastButtons></mat-paginator>
</div>
