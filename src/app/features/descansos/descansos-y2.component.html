<ui-page-header title="Descansos de reduccion"
                [subtitle]="subtitle"
                [actions]="true">
  <div actions class="flex flex-wrap gap-2 ml-auto">
    <ng-container *ifRoles="['ADMIN','SUPERVISOR']">

      <button mat-stroked-button color="primary"
              [routerLink]="['/descansos-y2/edicion']"
              [queryParams]="{ domingo: domingoActual }">
        <mat-icon class="mr-1">edit</mat-icon> Editar reducci√≥n
      </button>

      <button mat-stroked-button color="primary" (click)="generar()">
        <mat-icon class="mr-1">auto_mode</mat-icon> Generar reducciones
      </button>

      <button mat-stroked-button color="warn" (click)="eliminar()">
        <mat-icon class="mr-1">delete_forever</mat-icon> Eliminar reducciones
      </button>

      <button mat-stroked-button color="accent" (click)="exportarExcel()" *ifRoles="['SUPERVISOR','ADMIN']">
        <mat-icon class="mr-1">table_view</mat-icon> Exportar Excel
      </button>
    </ng-container>
  </div>
</ui-page-header>

<!-- --- Botonera generaci√≥n por partes --- -->
<div class="pro-toolbar card single">

  <div class="right flex items-center gap-2 flex-wrap">
    <button mat-stroked-button color="primary"
            [disabled]="genLoading.NOCHE"
            (click)="run('NOCHE')">
      <mat-icon *ngIf="!genLoading.NOCHE">nights_stay</mat-icon>
      <mat-progress-spinner *ngIf="genLoading.NOCHE" [diameter]="18" mode="indeterminate"></mat-progress-spinner>
      Generar Noche
    </button>

    <button mat-stroked-button color="primary"
            [disabled]="genLoading.MANANA"
            (click)="run('MANANA')">
      <mat-icon *ngIf="!genLoading.MANANA">wb_sunny</mat-icon>
      <mat-progress-spinner *ngIf="genLoading.MANANA" [diameter]="18" mode="indeterminate"></mat-progress-spinner>
      Generar Ma√±ana
    </button>

    <button mat-stroked-button color="primary"
            [disabled]="genLoading.TARDE"
            (click)="run('TARDE')">
      <mat-icon *ngIf="!genLoading.TARDE">wb_twilight</mat-icon>
      <mat-progress-spinner *ngIf="genLoading.TARDE" [diameter]="18" mode="indeterminate"></mat-progress-spinner>
      Generar Tarde
    </button>

    <button mat-stroked-button color="primary"
            [disabled]="genLoading.TURNO_FIJO"
            (click)="run('TURNO_FIJO')">
      <mat-icon *ngIf="!genLoading.TURNO_FIJO">schedule</mat-icon>
      <mat-progress-spinner *ngIf="genLoading.TURNO_FIJO" [diameter]="18" mode="indeterminate"></mat-progress-spinner>
      Generar Turno Fijo
    </button>

    <button mat-stroked-button color="accent"
            [disabled]="genLoading.GRUPO_Y2"
            (click)="run('GRUPO_Y2')">
      <mat-icon *ngIf="!genLoading.GRUPO_Y2">group</mat-icon>
      <mat-progress-spinner *ngIf="genLoading.GRUPO_Y2" [diameter]="18" mode="indeterminate"></mat-progress-spinner>
      Generar Grupo Y2
    </button>

    <button mat-stroked-button color="accent"
            [disabled]="genLoading.GRUPO_Y1"
            (click)="run('GRUPO_Y1')">
      <mat-icon *ngIf="!genLoading.GRUPO_Y1">person</mat-icon>
      <mat-progress-spinner *ngIf="genLoading.GRUPO_Y1" [diameter]="18" mode="indeterminate"></mat-progress-spinner>
      Generar Grupo Y1
    </button>
  </div>
</div>

<!-- Toolbar -->
<div class="pro-toolbar">
  <div class="nav-group left">
    <button mat-stroked-button (click)="irAnterior()" [disabled]="!habilitaAnterior">
      <mat-icon>chevron_left</mat-icon> Semana anterior
    </button>
  </div>

  <div class="filters center">
    <mat-form-field appearance="outline">
      <mat-icon matPrefix>group</mat-icon>
      <input matInput [(ngModel)]="filtroReemplazo" placeholder="Filtrar reemplazo‚Ä¶" />
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-icon matPrefix>person_search</mat-icon>
      <input matInput [(ngModel)]="filtroNombre" placeholder="Filtrar titular‚Ä¶" />
    </mat-form-field>
  </div>

  <div class="nav-group right">
    <button mat-stroked-button color="primary" (click)="irSiguiente()" [disabled]="!habilitaSiguiente">
      Semana siguiente <mat-icon>chevron_right</mat-icon>
    </button>
  </div>
</div>

<mat-progress-bar *ngIf="loading" mode="indeterminate"></mat-progress-bar>

<!-- Calendario -->
<div class="table-shell card" *ngIf="!loading">
  <div class="table-scroll">
    <table class="table table-bordered align-middle text-center">
      <thead class="table-head">
        <tr>
          <th class="sticky-col first-col">Reemplazo</th>
          <th *ngFor="let col of calendarCols; trackBy: trackByCol"
              [class.today-col]="isToday(col.iso)">
            <div class="th-line1">{{ col.label }}</div>
            <div class="th-line2">{{ col.iso }}</div>
          </th>
        </tr>
      </thead>

      <tbody>
        <tr *ngFor="let row of filteredRows(); trackBy: trackByRow">
          <td class="sticky-col first-col">
            <strong class="reemplazo-name">{{ row.reemplazo }}</strong>
          </td>

          <td *ngFor="let col of calendarCols; trackBy: trackByCol"
              [class.today-col]="isToday(col.iso)">
            <ng-container *ngIf="row.cells[col.iso] as cell; else empty">
              <!-- Agrupaci√≥n visual POR TURNO; dentro van sus franjas ordenadas -->
              <div class="turno-block" *ngFor="let tb of turnoBuckets(cell)">
                <div class="turno-badge">{{ tb.turno }}</div>
                <div class="turno-content">
                  <div class="franja-row" *ngFor="let g of tb.items">
                    <div class="franja-meta">
                      <span class="chip alt" *ngIf="g.puesto">{{ g.puesto }}</span>
                      <span class="dot" *ngIf="g.puesto">‚Ä¢</span>
                      <span class="chip tone" *ngIf="g.maquina">{{ g.maquina }}</span>
                      <span class="dot" *ngIf="g.franja">‚Ä¢</span>
                      <span class="chip mini" *ngIf="g.franja">{{ g.franja }}</span>
                      <span class="dot">‚Ä¢</span>
                      <span class="chip mini hours">{{ g.horas }}h</span>
                    </div>
                    <div class="people">
                      <span class="person" *ngFor="let c of g.colaboradores; let last = last">
                        {{ c }}<span *ngIf="!last">, </span>
                      </span>
                    </div>
                  </div>
                </div>
              </div>
            </ng-container>
            <div class="overlay-badge compensatorio"
                 *ngIf="isY1Ocupado(row.reemplazo, col.iso)">
              Compensatorio
            </div>
            <ng-template #empty> </ng-template>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<!-- Incidencias -->
<div *ifRoles="['ADMIN']">
  <div class="inc-container card" *ngIf="!loading">
    <div class="card-header d-flex justify-content-between align-items-center">
      <strong>‚ö†Ô∏è Incidencias</strong>
      <span class="badge bg-secondary">Total: {{ incTotal }}</span>
    </div>

    <div class="card-body" *ngIf="incTotal > 0; else noIncidencias">
      <div class="table-responsive">
        <table class="table table-sm table-striped">
          <thead>
            <tr>
              <th>Titular</th>
              <th>Grupo</th>
              <th>Fecha</th>
              <th>Turno</th>
              <th>Franja</th>
              <th>Motivo</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let i of incidencias">
              <td>{{ i.colaboradorNombre }}</td>
              <td>{{ i.grupo }}</td>
              <td>{{ i.fecha }}</td>
              <td>{{ i.turno || '‚Äî' }}</td>
              <td>{{ i.franja || '‚Äî' }}</td>
              <td class="text-danger">{{ i.motivo }}</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <ng-template #noIncidencias>
      <div class="p-3 text-muted">‚úîÔ∏è No hay incidencias en esta semana.</div>
    </ng-template>
  </div>
</div>

<div class="table-shell card mt-4" *ngIf="!loading">
  <h4 class="p-3">üìã Reducciones por colaborador (L‚ÄìS)</h4>

  <div class="table-scroll">
    <table class="table table-bordered text-center">
      <thead class="table-head">
        <tr>
          <th>Colaborador</th>
          <th *ngFor="let col of calendarCols.slice(0,6)">
            {{ col.label }}<br>
            <small>{{ col.iso }}</small>
          </th>
        </tr>
      </thead>

      <tbody>
        <tr *ngFor="let r of resumenColaboradores"
            [class.turno-noche]="r.esNoche"
            [class.venia-noche]="r.veniaDeNoche"
            [class.turno-manana]="r.esManana">
          <td class="name-cell">
            <div class="name-line">
              <strong>{{ r.nombre }}</strong>
              <span *ngIf="r.y2UltimoDiaDisplay" class="chip mini seed">
                √öltimo: {{ dayMap[r.y2UltimoDiaDisplay] || r.y2UltimoDiaDisplay }}
                <span *ngIf="r.y2DisplayForzado" class="seed-flag">‚Ä¢ forzado</span>
              </span>
              <button *ifRoles="['ADMIN','SUPERVISOR']"
                      class="mini-icon-btn"
                      mat-icon-button
                      (click)="abrirEditarSeed(r)"
                      aria-label="Editar √∫ltimo d√≠a de reducci√≥n">
                <mat-icon>tune</mat-icon>
              </button>
            </div>
          </td>

          <td *ngFor="let col of calendarCols.slice(0,6)">
            <ng-container *ngIf="r[col.iso] as x; else none">
              <div class="chip tone">{{ x.reemplazo }}</div>
              <div class="chip mini">{{ x.franja }}</div>
              <div class="chip mini">{{ x.horas }}h</div>
            </ng-container>
            <ng-template #none>‚Äî</ng-template>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<div *ngIf="mostrarEditarSeed" class="seed-editor-overlay">
  <div class="seed-editor-card">
    <h3 class="mb-2">√öltimo d√≠a de reducci√≥n</h3>
    <div class="row">
      <mat-form-field appearance="outline" class="w-100">
        <mat-label>√öltimo d√≠a</mat-label>
        <select matNativeControl [(ngModel)]="seedEditModel.day">
          <option *ngFor="let d of diasPermitidos" [value]="d.key">{{ d.label }}</option>
        </select>
      </mat-form-field>
    </div>

    <div class="actions mt-3">
      <button mat-stroked-button (click)="mostrarEditarSeed=false">Cancelar</button>
      <button mat-flat-button color="primary" (click)="guardarSeed()">Guardar</button>
    </div>
  </div>
</div>


<!-- Footer / Density -->
<div class="footer-actions">
  <div class="footer-center">
    <mat-button-toggle-group class="density-toggle" [value]="density" (change)="setDensity($event.value)">
      <mat-button-toggle value="comfortable">C√≥moda</mat-button-toggle>
      <mat-button-toggle value="compact">Compacta</mat-button-toggle>
      <mat-button-toggle value="ultra">Ultra</mat-button-toggle>
    </mat-button-toggle-group>
  </div>
</div>

<!-- Overlay pantalla completa -->
<div *ngIf="fullscreenLoading" class="fullscreen-loader" aria-live="assertive" aria-busy="true">
  <div class="loader-orbit" role="progressbar" aria-label="Procesando">
    <div class="ball"></div>
  </div>
  <div class="loader-text">Cargando‚Ä¶</div>
</div>
