<ui-page-header title="Edición de reducciones" [subtitle]="subtitle" [actions]="true">
  <div actions class="flex flex-wrap gap-2 ml-auto">
    <button mat-stroked-button color="primary" (click)="volver()">
      <mat-icon class="mr-1">arrow_back</mat-icon> Volver a la semana
    </button>
    <mat-button-toggle-group class="density-toggle" [value]="density" (valueChange)="setDensity($event)">
      <mat-button-toggle value="comfortable">Cómoda</mat-button-toggle>
      <mat-button-toggle value="compact">Compacta</mat-button-toggle>
      <mat-button-toggle value="ultra">Ultra</mat-button-toggle>
    </mat-button-toggle-group>
  </div>
</ui-page-header>

<mat-progress-bar *ngIf="loading" mode="indeterminate"></mat-progress-bar>

<!-- ===== CALENDARIO estilo DescansosY2 (con slots vacíos + CRUD inline) ===== -->
<div class="table-shell card" *ngIf="!loading">
  <div class="table-scroll">
    <table class="table table-bordered align-middle text-center">
      <thead class="table-head">
        <tr>
          <th class="sticky-col first-col">Reemplazo</th>
          <th *ngFor="let col of calendarCols" [class.today-col]="isToday(col.iso)">
            <div class="th-line1">{{ col.label }}</div>
            <div class="th-line2">{{ col.iso }}</div>
          </th>
        </tr>
      </thead>

      <tbody>
        <tr *ngFor="let row of calendarRows">
          <td class="sticky-col first-col">
            <strong class="reemplazo-name">{{ row.reemplazo }}</strong>
          </td>

          <td *ngFor="let col of calendarCols" [class.today-col]="isToday(col.iso)">
            <ng-container *ngIf="row.cells[col.iso] as cell; else emptyCell">
              <!-- buckets por turno -->
              <div class="turno-block" *ngFor="let g of cell.groups">
                <div class="turno-badge">{{ turnoBadge(g.turno) }}</div>

                <div class="franja-row" [class.empty-slot]="g.empty">
                  <div class="franja-meta">
                    <span class="chip alt" *ngIf="g.puesto && g.puesto !== '—'">{{ g.puesto }}</span>
                    <span class="dot" *ngIf="g.puesto && g.puesto !== '—'">•</span>
                    <span class="chip tone" *ngIf="g.maquina && g.maquina !== '—'">{{ g.maquina }}</span>
                    <span class="dot" *ngIf="g.franja">•</span>
                    <span class="chip mini" *ngIf="g.franja">{{ g.franja }}</span>
                    <span class="dot">•</span>
                    <span class="chip mini hours">{{ g.horas }}h</span>
                  </div>

                  <!-- SLOT VACÍO: crear o mover aquí -->
                  <div class="people" *ngIf="g.empty">
                    <button mat-stroked-button class="slot-btn"
                            (click)="onClickEmptySlot(col.iso, g.turno, g.franja)"
                            matTooltip="Crear (o mover seleccionado) aquí">
                      <mat-icon>add</mat-icon> {{ selectedId ? 'Mover' : 'Crear' }}
                    </button>
                  </div>

                  <!-- SLOT OCUPADO: chips con acciones -->
                  <div class="people" *ngIf="!g.empty">
                    <ng-container *ngFor="let name of g.nombres; let i = index">
                      <button class="person-btn"
                              mat-stroked-button
                              [class.selected]="selectedId === g.ids[i]"
                              (click)="onClickPerson(g, i)"
                              [matTooltip]="'Seleccionar: ' + name">
                        {{ name }}
                      </button>
                      <button mat-icon-button color="warn"
                              (click)="eliminarById(g.ids[i])"
                              matTooltip="Eliminar">
                        <mat-icon>delete</mat-icon>
                      </button>
                    </ng-container>
                  </div>
                </div>
              </div>
            </ng-container>

            <ng-template #emptyCell>—</ng-template>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<!-- ===== PANELES (conservados): IZQ Backlog / DER Acciones CRUD ===== -->
<div class="grid-shell" *ngIf="!loading">
  <!-- IZQUIERDA: Backlog / Sugerencias -->
  <section class="panel card">
    <header class="panel-header">
      <h3>Backlog y sugerencias</h3>
      <small class="muted">Estado por persona, día propio y slots vacíos.</small>
    </header>

    <div class="backlog-list">
      <div class="backlog-item" *ngFor="let b of backlog; trackBy: trackByBacklog">
        <div class="row-top">
          <div class="who">
            <strong>{{ b.nombre }}</strong>
            <span class="tag">{{ b.grupo }}</span>
          </div>
          <div class="hours">
            <span class="chip hours">Backlog: {{ b.backlogHorasHastaBase }}h</span>
          </div>
        </div>

        <div class="row-mid">
          <span class="chip alt">Día propio: {{ b.diaPropioFecha }} ({{ b.diaPropio }})</span>
          <span class="chip tone">Turno sugerido: {{ b.turnoSugerido || '—' }}</span>
          <span class="chip mini" *ngIf="b.franjaSugerida">Franja: {{ b.franjaSugerida }}</span>
        </div>

        <div class="row-bottom" *ngIf="b.incidenciasSemana?.length">
          <mat-icon>warning_amber</mat-icon>
          <span class="incidencia" *ngFor="let i of b.incidenciasSemana; let last = last">
            {{ i }}<span *ngIf="!last"> · </span>
          </span>
        </div>

        <div class="row-slots" *ngIf="b.slotsVaciosDia?.length">
          <div class="slot" *ngFor="let s of b.slotsVaciosDia" [class.libre]="s.libre">
            <span class="s-turno">{{ s.turno }}</span>
            <span class="s-franja">{{ s.franja }}</span>
            <span class="s-estado">{{ s.libre ? 'Libre' : 'Ocupado' }}</span>
          </div>
        </div>

        <div class="row-disponibles" *ngIf="b.y2Disponibles?.length">
          <span class="title">Y2 disponibles:</span>
          <div class="pills">
            <span class="pill" *ngFor="let y of b.y2Disponibles" [matTooltip]="y.observacionCompatibilidad">
              {{ y.nombre }}
            </span>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- DERECHA: Acciones CRUD (tus formularios intactos) -->
  <section class="panel card" *ifRoles="['SUPERVISOR','ADMIN']">
    <header class="panel-header">
      <h3>Acciones</h3>
      <small class="muted">Crear, mover, eliminar, intercambiar y otorgar horas.</small>
    </header>

    <div class="actions-grid">
      <!-- CREAR -->
      <div class="action-block">
        <h4><mat-icon>add_circle</mat-icon> Crear descanso</h4>
        <form [formGroup]="fCrear" class="form-grid">
          <mat-form-field appearance="outline">
            <mat-label>Colaborador</mat-label>
            <mat-select formControlName="colaboradorId">
              <mat-option *ngFor="let c of colaboradoresList" [value]="c.id">{{ c.nombre }}</mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Fecha</mat-label>
            <input matInput [matDatepicker]="dp1" formControlName="fecha">
            <mat-datepicker-toggle matSuffix [for]="dp1"></mat-datepicker-toggle>
            <mat-datepicker #dp1></mat-datepicker>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Horas</mat-label>
            <mat-select formControlName="horas">
              <mat-option [value]="4">4 horas</mat-option>
              <mat-option [value]="8">8 horas (Día completo)</mat-option>
            </mat-select>
          </mat-form-field>

          <!-- Franja filtrada por turno real sugerido -->
          <mat-form-field appearance="outline" *ngIf="fCrear.value.horas === 4">
            <mat-label>Franja</mat-label>
            <mat-select formControlName="franja">
              <mat-option *ngIf="turnoCrear === 'MAN'" value="06:00-10:00">06:00–10:00</mat-option>
              <mat-option *ngIf="turnoCrear === 'MAN'" value="10:00-14:00">10:00–14:00</mat-option>
              <mat-option *ngIf="turnoCrear === 'TAR'" value="14:00-18:00">14:00–18:00</mat-option>
              <mat-option *ngIf="turnoCrear === 'TAR'" value="18:00-22:00">18:00–22:00</mat-option>
            </mat-select>
          </mat-form-field>

          <!-- Y2 reemplazo (usar disponiblesCrear EN EL MISMO FORM) -->
          <mat-form-field appearance="outline">
            <mat-label>Y2 reemplazo (opcional)</mat-label>
            <mat-select formControlName="reemplazoId">
              <mat-option [value]="null">— Auto / según disponibilidad —</mat-option>
              <mat-option *ngFor="let y of disponiblesCrear" [value]="y.colaboradorId">
                {{ y.nombre }}
              </mat-option>
            </mat-select>
          </mat-form-field>

          <mat-slide-toggle formControlName="acumuladasPrevias">Acumular horas previas</mat-slide-toggle>
          <mat-slide-toggle formControlName="forzar">Forzar reglas no críticas</mat-slide-toggle>

          <div class="buttons">
            <button mat-flat-button color="primary" (click)="crear()" [disabled]="working">Crear</button>
          </div>
        </form>
      </div>

      <!-- ACTUALIZAR -->
      <div class="action-block">
        <h4><mat-icon>edit_calendar</mat-icon> Mover / Editar</h4>
        <form [formGroup]="fActualizar" class="form-grid">
          <mat-form-field appearance="outline">
            <mat-label>Registro</mat-label>
            <mat-select formControlName="id">
              <mat-option *ngFor="let d of descansosData" [value]="d.id">
                {{ d.fechaReduccion }} — {{ d.colaborador }} ({{ d.horas }}h {{ d.franja || 'DIA_COMPLETO' }})
              </mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Nueva fecha</mat-label>
            <input matInput [matDatepicker]="dp2" formControlName="nuevaFecha">
            <mat-datepicker-toggle matSuffix [for]="dp2"></mat-datepicker-toggle>
            <mat-datepicker #dp2></mat-datepicker>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Horas</mat-label>
            <mat-select formControlName="horas">
              <mat-option [value]="null">— Mantener —</mat-option>
              <mat-option [value]="4">4 horas</mat-option>
              <mat-option [value]="8">8 horas (Día completo)</mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline" *ngIf="fActualizar.value.horas === 4">
            <mat-label>Franja</mat-label>
            <mat-select formControlName="franja">
              <mat-option [value]="null">— Sugerida —</mat-option>
              <mat-option value="06:00-10:00">06:00–10:00</mat-option>
              <mat-option value="10:00-14:00">10:00–14:00</mat-option>
              <mat-option value="14:00-18:00">14:00–18:00</mat-option>
              <mat-option value="18:00-22:00">18:00–22:00</mat-option>
            </mat-select>
          </mat-form-field>

          <!-- Reemplazo usando disponiblesCrear, dentro del form -->
          <mat-form-field appearance="outline">
            <mat-label>Y2 reemplazo (opcional)</mat-label>
            <mat-select formControlName="reemplazoId">
              <mat-option [value]="null">— Mantener / Auto —</mat-option>
              <mat-option *ngFor="let y of disponiblesCrear" [value]="y.colaboradorId">
                {{ y.nombre }}
              </mat-option>
            </mat-select>
          </mat-form-field>

          <mat-slide-toggle formControlName="forzar">Forzar</mat-slide-toggle>

          <div class="buttons">
            <button mat-flat-button color="primary" (click)="actualizar()" [disabled]="working">Guardar</button>
          </div>
        </form>
      </div>

      <!-- ELIMINAR / OTORGAR -->
      <div class="action-block">
        <h4><mat-icon>delete_sweep</mat-icon> Eliminar / Otorgar horas</h4>

        <div class="inline-table">
          <table mat-table [dataSource]="descansosData" class="mat-elevation-z0">
            <ng-container matColumnDef="fecha">
              <th mat-header-cell *matHeaderCellDef>Fecha</th>
              <td mat-cell *matCellDef="let d">{{ d.fechaReduccion }}</td>
            </ng-container>

            <ng-container matColumnDef="colab">
              <th mat-header-cell *matHeaderCellDef>Titular</th>
              <td mat-cell *matCellDef="let d">{{ d.colaborador }}</td>
            </ng-container>

            <ng-container matColumnDef="info">
              <th mat-header-cell *matHeaderCellDef>Info</th>
              <td mat-cell *matCellDef="let d">{{ d.horas }}h · {{ d.turno }} · {{ d.franja || 'DIA_COMPLETO' }}</td>
            </ng-container>

            <ng-container matColumnDef="acc">
              <th mat-header-cell *matHeaderCellDef></th>
              <td mat-cell *matCellDef="let d">
                <button mat-icon-button color="warn" matTooltip="Eliminar" (click)="confirmarEliminar(d)">
                  <mat-icon>delete</mat-icon>
                </button>
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="['fecha','colab','info','acc']"></tr>
            <tr mat-row *matRowDef="let row; columns: ['fecha','colab','info','acc'];"></tr>
          </table>
        </div>

        <div class="sub-block">
          <h5>Otorgar solo horas</h5>
          <form [formGroup]="fOtorgar" class="form-inline">
            <mat-form-field appearance="outline">
              <mat-label>Colaborador</mat-label>
              <mat-select formControlName="colaboradorId">
                <mat-option *ngFor="let c of colaboradoresList" [value]="c.id">{{ c.nombre }}</mat-option>
              </mat-select>
            </mat-form-field>
            <mat-form-field appearance="outline">
              <mat-label>Horas</mat-label>
              <input matInput type="number" formControlName="horas" min="1">
            </mat-form-field>
            <mat-slide-toggle formControlName="diferirASiguiente">Diferir a prox. semana</mat-slide-toggle>
            <button mat-stroked-button color="primary" (click)="otorgarHoras()" [disabled]="working">Otorgar</button>
          </form>
        </div>
      </div>

      <!-- SWAP (conservado) -->
      <div class="action-block">
        <h4><mat-icon>swap_horiz</mat-icon> Intercambiar descansos</h4>
        <div class="swap-grid">
          <div class="swap-col">
            <div class="swap-title">A</div>
            <div class="swap-list">
              <button class="swap-item" *ngFor="let d of descansosData" (click)="pickSwapA(d)"
                      [class.active]="swapA?.id===d.id">
                {{ d.fechaReduccion }} · {{ d.colaborador }} · {{ d.franja || 'DIA_COMPLETO' }}
              </button>
            </div>
          </div>
          <div class="swap-col">
            <div class="swap-title">B</div>
            <div class="swap-list">
              <button class="swap-item" *ngFor="let d of descansosData" (click)="pickSwapB(d)"
                      [class.active]="swapB?.id===d.id">
                {{ d.fechaReduccion }} · {{ d.colaborador }} · {{ d.franja || 'DIA_COMPLETO' }}
              </button>
            </div>
          </div>
        </div>
        <div class="swap-actions">
          <mat-slide-toggle [(ngModel)]="forzarSwap">Forzar</mat-slide-toggle>
          <button mat-flat-button color="primary" (click)="doSwap()" [disabled]="working">Intercambiar</button>
        </div>
      </div>
    </div>
  </section>
</div>

<!-- Overlay trabajo -->
<div *ngIf="working" class="fullscreen-loader" aria-live="assertive" aria-busy="true">
  <div class="loader-orbit"><div class="ball"></div></div>
  <div class="loader-text">Procesando…</div>
</div>
